<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atti Tutor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .app {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        h1 { font-size: 3rem; color: #1f2937; margin-bottom: 1rem; font-weight: 300; text-align: center; }
        .subtitle { color: #6b7280; font-size: 1.2rem; margin-bottom: 2rem; text-align: center; }
        .success { background: #dcfce7; color: #16a34a; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center; }
        .form { background: #f9fafb; padding: 2rem; border-radius: 0.5rem; margin: 2rem 0; }
        input, textarea, button { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
        button { background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: 500; }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .friends { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .friend { background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; position: relative; }
        .remove-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.8rem; }
        .story { background: #f0f9ff; padding: 2rem; border-radius: 0.5rem; border: 1px solid #0ea5e9; margin-top: 2rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        function AttiTutor() {
            const [topic, setTopic] = useState('');
            const [friends, setFriends] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [newFriend, setNewFriend] = useState({ name: '', memory: '' });
            const [story, setStory] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('openrouter_api_key') || '');
            const [showApiKeyForm, setShowApiKeyForm] = useState(!localStorage.getItem('openrouter_api_key'));

            const saveApiKey = (e) => {
                e.preventDefault();
                if (apiKey.trim()) {
                    localStorage.setItem('openrouter_api_key', apiKey.trim());
                    setShowApiKeyForm(false);
                }
            };

            const addFriend = (e) => {
                e.preventDefault();
                if (newFriend.name.trim()) {
                    setFriends([...friends, { 
                        id: Date.now(), 
                        name: newFriend.name.trim(), 
                        memory: newFriend.memory.trim() 
                    }]);
                    setNewFriend({ name: '', memory: '' });
                    setShowForm(false);
                }
            };

            const removeFriend = (id) => {
                setFriends(friends.filter(friend => friend.id !== id));
            };

            const generateStory = async () => {
                if (!topic.trim() || friends.length === 0 || !apiKey) return;

                setIsLoading(true);
                setStory('');

                try {
                    const friendsInfo = friends.map(f => `${f.name}${f.memory ? ` (${f.memory})` : ''}`).join(', ');
                    
                    const prompt = `Create an engaging, educational story about "${topic}" that incorporates these friends: ${friendsInfo}. 

                    Make it feel like a real experience where the friends naturally demonstrate or encounter the concept of "${topic}" in their daily lives. Include:
                    - A specific scenario where they interact with the topic
                    - How each friend's personality (based on their memory/trait) influences their approach
                    - Clear educational content about ${topic} woven naturally into the story
                    - A satisfying conclusion that reinforces the learning

                    Write it in first person as if recounting a memory. Make it warm, relatable, and educational. Keep it concise but impactful.`;

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'X-Title': 'Atti Tutor'
                        },
                        body: JSON.stringify({
                            model: 'qwen/qwen-2.5-72b-instruct',
                            messages: [{
                                role: 'user',
                                content: prompt
                            }],
                            max_tokens: 1000,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const generatedStory = data.choices[0]?.message?.content || 'Sorry, I couldn\'t generate a story right now.';
                    
                    setStory(generatedStory.replace(/\n/g, '<br>'));
                } catch (error) {
                    console.error('Error generating story:', error);
                    setStory(`<div style="color: #ef4444;">‚ùå Error generating story: ${error.message}</div>`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="app">
                    <h1>üéì Atti Tutor</h1>
                    <p className="subtitle">Learn anything through stories about your friends</p>
                    
                    {showApiKeyForm && (
                        <div className="form" style={{background: '#fef3c7', border: '1px solid #f59e0b'}}>
                            <h3>üîë API Key Required</h3>
                            <p style={{marginBottom: '1rem', color: '#92400e'}}>
                                To generate AI stories, you need an OpenRouter API key. Get one free at{' '}
                                <a href="https://openrouter.ai/keys" target="_blank" style={{color: '#1d4ed8'}}>
                                    openrouter.ai/keys
                                </a>
                            </p>
                            <form onSubmit={saveApiKey}>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Enter your OpenRouter API key"
                                    required
                                />
                                <button type="submit" style={{background: '#059669'}}>
                                    Save API Key
                                </button>
                            </form>
                        </div>
                    )}
                    
                    <div className="form">
                        <h3>What would you like to learn?</h3>
                        <input
                            type="text"
                            value={topic}
                            onChange={(e) => setTopic(e.target.value)}
                            placeholder="Enter any topic (e.g., photosynthesis, calculus, machine learning...)"
                        />
                    </div>
                    
                    <div className="form">
                        <h3>Your Friends ({friends.length})</h3>
                        
                        {friends.length === 0 ? (
                            <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                Add friends to create personalized learning stories!
                            </p>
                        ) : (
                            <div className="friends">
                                {friends.map((friend) => (
                                    <div key={friend.id} className="friend">
                                        <button 
                                            className="remove-btn" 
                                            onClick={() => removeFriend(friend.id)}
                                            title="Remove friend"
                                        >
                                            √ó
                                        </button>
                                        <strong>{friend.name}</strong>
                                        {friend.memory && (
                                            <div style={{marginTop: '0.5rem', fontStyle: 'italic', color: '#6b7280'}}>
                                                "{friend.memory}"
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {!showForm ? (
                            <button onClick={() => setShowForm(true)} style={{background: '#10b981'}}>
                                + Add Friend
                            </button>
                        ) : (
                            <form onSubmit={addFriend}>
                                <input
                                    type="text"
                                    value={newFriend.name}
                                    onChange={(e) => setNewFriend({...newFriend, name: e.target.value})}
                                    placeholder="Friend's name"
                                    required
                                />
                                <textarea
                                    value={newFriend.memory}
                                    onChange={(e) => setNewFriend({...newFriend, memory: e.target.value})}
                                    placeholder="Share a memory or personality trait about this friend..."
                                    rows="3"
                                />
                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                    <button type="submit" style={{background: '#10b981'}}>Add</button>
                                    <button 
                                        type="button" 
                                        onClick={() => {setShowForm(false); setNewFriend({name: '', memory: ''});}}
                                        style={{background: '#6b7280'}}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        )}
                    </div>
                    
                    <button
                        onClick={generateStory}
                        disabled={!topic.trim() || friends.length === 0 || !apiKey || isLoading}
                        style={{
                            background: (!topic.trim() || friends.length === 0 || !apiKey || isLoading) ? '#9ca3af' : '#059669',
                            fontSize: '1.1rem',
                            padding: '1rem'
                        }}
                    >
                        {isLoading ? '‚ú® Creating Your Story...' : 'Create My Learning Story! üìö'}
                    </button>
                    
                    {!apiKey && !showApiKeyForm && (
                        <button 
                            onClick={() => setShowApiKeyForm(true)} 
                            style={{background: '#f59e0b', marginTop: '0.5rem'}}
                        >
                            üîë Add API Key
                        </button>
                    )}
                    
                    {story && (
                        <div className="story" dangerouslySetInnerHTML={{__html: story}} />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AttiTutor));
    </script>
</body>
</html>
