<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Atti Tutor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
        }
        
        .app {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 { 
            font-size: 3.5rem; 
            color: #1d1d1f; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            text-align: center;
            letter-spacing: -0.02em;
        }
        
        .subtitle { 
            color: #86868b; 
            font-size: 1.3rem; 
            margin-bottom: 3rem; 
            text-align: center;
            font-weight: 400;
        }
        
        .form { 
            background: rgba(247, 247, 247, 0.8); 
            padding: 2.5rem; 
            border-radius: 16px; 
            margin: 2rem 0;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .form h3 {
            color: #1d1d1f;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }
        
        input, textarea {
            width: 100%; 
            padding: 1rem 1.2rem; 
            margin: 0.8rem 0; 
            border: 2px solid #e5e5e7; 
            border-radius: 12px; 
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
            background: #ffffff;
        }
        
        button { 
            width: 100%;
            background: #007aff;
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            padding: 1.2rem 2rem;
            margin: 0.8rem 0;
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            letter-spacing: -0.01em;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        button:hover:not(:disabled) { 
            background: #0051d5;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled { 
            background: #d1d1d6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .friends { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 1.5rem; 
            margin: 1.5rem 0; 
        }
        
        .friend { 
            background: rgba(255, 255, 255, 0.9);
            padding: 1.8rem; 
            border-radius: 16px; 
            border: 1px solid rgba(0, 0, 0, 0.06);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .friend:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        
        .friend strong {
            color: #1d1d1f;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .remove-btn { 
            position: absolute; 
            top: 1rem; 
            right: 1rem; 
            background: #ff3b30;
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-btn:hover {
            background: #d70015;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }
        
        .story { 
            background: rgba(0, 122, 255, 0.05);
            padding: 2.5rem; 
            border-radius: 16px; 
            border: 1px solid rgba(0, 122, 255, 0.1);
            margin-top: 2rem;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .story strong {
            color: #1d1d1f;
            font-weight: 600;
        }
        
        .api-key-form {
            background: rgba(255, 204, 0, 0.1);
            border: 1px solid rgba(255, 149, 0, 0.2) !important;
        }
        
        .api-key-form h3 {
            color: #bf5700;
        }
        
        .api-key-form p {
            color: #8b4513;
        }
        
        .api-key-form a {
            color: #007aff;
            text-decoration: none;
            font-weight: 600;
        }
        
        .api-key-form a:hover {
            text-decoration: underline;
        }
        
        .green-btn {
            background: #30d158 !important;
        }
        
        .green-btn:hover:not(:disabled) {
            background: #248a3d !important;
            box-shadow: 0 8px 25px rgba(48, 209, 88, 0.3) !important;
        }
        
        .orange-btn {
            background: #ff9500 !important;
        }
        
        .orange-btn:hover:not(:disabled) {
            background: #e8890b !important;
            box-shadow: 0 8px 25px rgba(255, 149, 0, 0.3) !important;
        }
        
        .gray-btn {
            background: #8e8e93 !important;
        }
        
        .gray-btn:hover:not(:disabled) {
            background: #6d6d70 !important;
            box-shadow: 0 8px 25px rgba(142, 142, 147, 0.3) !important;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .api-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .api-info-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .api-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-btn {
            background: #8e8e93;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .close-btn:hover {
            background: #6d6d70;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
        }
        
        .api-status.connected {
            background: rgba(48, 209, 88, 0.1);
            border: 1px solid rgba(48, 209, 88, 0.2);
            color: #248a3d;
        }
        
        .api-status.error {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            color: #d70015;
        }
        
        .api-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .small-btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
            margin: 0 !important;
            width: auto !important;
        }
        
        .empty-state {
            color: #86868b;
            text-align: center;
            padding: 3rem;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .app {
                margin: 0;
                padding: 1.5rem;
                border-radius: 16px;
                max-width: 100%;
            }
            
            h1 {
                font-size: 2.2rem;
                margin-bottom: 0.5rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
                margin-bottom: 2rem;
            }
            
            .form {
                padding: 1.5rem;
                margin: 1.5rem 0;
            }
            
            .form h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }
            
            input, textarea {
                padding: 0.9rem 1rem;
                font-size: 1rem;
            }
            
            button {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
            
            .friends {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .friend {
                padding: 1.2rem;
            }
            
            .button-group {
                flex-direction: column;
                gap: 0.8rem;
            }
            
            .story {
                padding: 1.5rem;
                font-size: 1rem;
                line-height: 1.6;
            }
            
            .remove-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            
            .app {
                padding: 1rem;
                border-radius: 12px;
            }
            
            h1 {
                font-size: 1.8rem;
                letter-spacing: -0.01em;
            }
            
            .subtitle {
                font-size: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .form {
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 12px;
            }
            
            .form h3 {
                font-size: 1.1rem;
            }
            
            input, textarea, button {
                padding: 0.8rem;
                font-size: 0.95rem;
                border-radius: 10px;
            }
            
            .friend {
                padding: 1rem;
                border-radius: 12px;
            }
            
            .friend strong {
                font-size: 1.1rem;
            }
            
            .story {
                padding: 1rem;
                border-radius: 12px;
                font-size: 0.95rem;
            }
            
            .empty-state {
                padding: 2rem;
                font-size: 1rem;
            }
        }
        
        @media (max-height: 600px) and (orientation: landscape) {
            .app {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .subtitle {
                margin-bottom: 1.5rem;
            }
            
            .form {
                padding: 1.5rem;
                margin: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        function AttiTutor() {
            const [topic, setTopic] = useState('');
            const [friends, setFriends] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [newFriend, setNewFriend] = useState({ name: '', memory: '' });
            const [story, setStory] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('openrouter_api_key') || '');
            const [showApiKeyForm, setShowApiKeyForm] = useState(!localStorage.getItem('openrouter_api_key'));
            const [showApiInfo, setShowApiInfo] = useState(false);
            const [apiError, setApiError] = useState(false);

            const saveApiKey = (e) => {
                e.preventDefault();
                if (apiKey.trim()) {
                    localStorage.setItem('openrouter_api_key', apiKey.trim());
                    setShowApiKeyForm(false);
                    setApiError(false);
                }
            };

            const changeApiKey = () => {
                setShowApiKeyForm(true);
                setApiError(false);
                setStory('');
            };

            const removeApiKey = () => {
                localStorage.removeItem('openrouter_api_key');
                setApiKey('');
                setShowApiKeyForm(true);
                setApiError(false);
                setStory('');
            };

            const addFriend = (e) => {
                e.preventDefault();
                if (newFriend.name.trim()) {
                    setFriends([...friends, { 
                        id: Date.now(), 
                        name: newFriend.name.trim(), 
                        memory: newFriend.memory.trim() 
                    }]);
                    setNewFriend({ name: '', memory: '' });
                    setShowForm(false);
                }
            };

            const removeFriend = (id) => {
                setFriends(friends.filter(friend => friend.id !== id));
            };

            const generateStory = async () => {
                if (!topic.trim() || friends.length === 0 || !apiKey) return;

                setIsLoading(true);
                setStory('');

                try {
                    const friendsInfo = friends.map(f => `${f.name}${f.memory ? ` (${f.memory})` : ''}`).join(', ');
                    
                    const prompt = `Generate a comprehensive, fun, and memorable educational answer about "${topic}" that incorporates these friends: ${friendsInfo}. 

                    🎯 **REQUIREMENTS:**
                    
                    1. **📚 Academic Definition**: Start with the exact formal definition that would be expected on an Anna University answer sheet - precise, technical, and complete.
                    
                    2. **🧒 5th Grade Explanation**: Break down the concept from absolute basics, assuming zero prior knowledge. Use simple words and build up step by step.
                    
                    3. **📋 Conceptual Order**: Structure the explanation in logical, sequential steps that build upon each other naturally.
                    
                    4. **🎭 Friend Story Integration**: Weave in a relatable story featuring ${friendsInfo} that demonstrates the concept in action, using their personalities/traits.
                    
                    5. **😊 Cute Emojis & Memory Aids**: Include relevant emojis throughout and create memorable phrases, rhymes, or mental images that help recall key points.
                    
                    6. **🔄 Reinforcement**: End with a summary that connects the story back to the academic definition and provides memory hooks.
                    
                    **FORMAT:**
                    📖 **Official Definition**: [Anna University style definition]
                    
                    🎯 **Simple Explanation**: [5th grade level breakdown]
                    
                    📚 **Step-by-Step Concepts**: [Logical order building blocks]
                    
                    👥 **Friend Story**: [Engaging story with ${friendsInfo}]
                    
                    🧠 **Memory Hooks**: [Emojis, rhymes, and recall techniques]
                    
                    ✅ **Quick Recap**: [Connect story to definition]
                    
                    Make it comprehensive, memorable, and academically sound while keeping it engaging and fun!`;

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'X-Title': 'Atti Tutor'
                        },
                        body: JSON.stringify({
                            model: 'qwen/qwen-2.5-72b-instruct',
                            messages: [{
                                role: 'user',
                                content: prompt
                            }],
                            max_tokens: 2000,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const generatedStory = data.choices[0]?.message?.content || 'Sorry, I couldn\'t generate a story right now.';
                    
                    // Format the response with better line breaks and structure
                    const formattedStory = generatedStory
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/📖|🎯|📚|👥|🧠|✅/g, '<br><br>$&');
                    
                    setStory(`<p>${formattedStory}</p>`);
                } catch (error) {
                    console.error('Error generating story:', error);
                    setApiError(true);
                    setStory(`<div style="color: #ff3b30; background: rgba(255, 59, 48, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255, 59, 48, 0.2);">
                        <strong>❌ API Error: ${error.message}</strong>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">This might be due to an invalid API key, insufficient credits, or network issues.</p>
                    </div>`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="app">
                    <h1>🎓 Atti Tutor</h1>
                    <p className="subtitle">Learn anything through stories about your friends</p>
                    
                    {/* API Key Form */}
                    {showApiKeyForm && (
                        <div className="form api-key-form">
                            <h3>🔑 API Key Required</h3>
                            <p style={{marginBottom: '1.5rem'}}>
                                To generate AI stories, you need an OpenRouter API key. Get one free at{' '}
                                <a href="https://openrouter.ai/keys" target="_blank">
                                    openrouter.ai/keys
                                </a>
                            </p>
                            <form onSubmit={saveApiKey}>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Enter your OpenRouter API key"
                                    required
                                />
                                <div className="api-actions">
                                    <button type="submit" className="green-btn">
                                        Save API Key
                                    </button>
                                    {apiKey && (
                                        <button 
                                            type="button" 
                                            onClick={() => setShowApiKeyForm(false)}
                                            className="gray-btn small-btn"
                                        >
                                            Cancel
                                        </button>
                                    )}
                                </div>
                            </form>
                        </div>
                    )}
                    
                    {/* API Management Bar */}
                    {apiKey && !showApiKeyForm && (
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                <button 
                                    onClick={() => setShowApiInfo(true)}
                                    className="small-btn"
                                    style={{background: '#007aff'}}
                                >
                                    ℹ️ API Info
                                </button>
                                <button 
                                    onClick={changeApiKey}
                                    className="orange-btn small-btn"
                                >
                                    🔄 Change Key
                                </button>
                            </div>
                            {apiError && (
                                <div style={{color: '#ff3b30', fontSize: '0.9rem', fontWeight: '600'}}>
                                    ⚠️ API Issue Detected
                                </div>
                            )}
                        </div>
                    )}
                    
                    <div className="form">
                        <h3>What would you like to learn?</h3>
                        <input
                            type="text"
                            value={topic}
                            onChange={(e) => setTopic(e.target.value)}
                            placeholder="Enter any topic (e.g., photosynthesis, calculus, machine learning...)"
                        />
                    </div>
                    
                    <div className="form">
                        <h3>Your Friends ({friends.length})</h3>
                        
                        {friends.length === 0 ? (
                            <div className="empty-state">
                                Add friends to create personalized learning stories!
                            </div>
                        ) : (
                            <div className="friends">
                                {friends.map((friend) => (
                                    <div key={friend.id} className="friend">
                                        <button 
                                            className="remove-btn" 
                                            onClick={() => removeFriend(friend.id)}
                                            title="Remove friend"
                                        >
                                            ×
                                        </button>
                                        <strong>{friend.name}</strong>
                                        {friend.memory && (
                                            <div style={{marginTop: '1rem', fontStyle: 'italic', color: '#86868b', fontSize: '1rem'}}>
                                                "{friend.memory}"
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {!showForm ? (
                            <button onClick={() => setShowForm(true)} className="green-btn">
                                + Add Friend
                            </button>
                        ) : (
                            <form onSubmit={addFriend}>
                                <input
                                    type="text"
                                    value={newFriend.name}
                                    onChange={(e) => setNewFriend({...newFriend, name: e.target.value})}
                                    placeholder="Friend's name"
                                    required
                                />
                                <textarea
                                    value={newFriend.memory}
                                    onChange={(e) => setNewFriend({...newFriend, memory: e.target.value})}
                                    placeholder="Share a memory or personality trait about this friend..."
                                    rows="3"
                                />
                                <div className="button-group">
                                    <button type="submit" className="green-btn">Add</button>
                                    <button 
                                        type="button" 
                                        onClick={() => {setShowForm(false); setNewFriend({name: '', memory: ''});}}
                                        className="gray-btn"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        )}
                    </div>
                    
                    <button
                        onClick={generateStory}
                        disabled={!topic.trim() || friends.length === 0 || !apiKey || isLoading}
                        style={{
                            fontSize: '1.2rem',
                            padding: '1.5rem',
                            marginTop: '1rem'
                        }}
                    >
                        {isLoading ? '✨ Creating Your Story...' : 'Create My Learning Story! 📚'}
                    </button>
                    
                    {!apiKey && !showApiKeyForm && (
                        <button 
                            onClick={() => setShowApiKeyForm(true)} 
                            className="orange-btn"
                            style={{marginTop: '1rem'}}
                        >
                            🔑 Add API Key
                        </button>
                    )}
                    
                    {story && (
                        <div className="story" dangerouslySetInnerHTML={{__html: story}} />
                    )}
                    
                    {/* API Error Recovery */}
                    {apiError && story && (
                        <div style={{textAlign: 'center', marginTop: '1rem'}}>
                            <button onClick={changeApiKey} className="orange-btn">
                                🔧 Fix API Key
                            </button>
                        </div>
                    )}
                    
                    {/* API Info Modal */}
                    {showApiInfo && (
                        <div className="api-info-modal" onClick={() => setShowApiInfo(false)}>
                            <div className="api-info-content" onClick={(e) => e.stopPropagation()}>
                                <div className="api-info-header">
                                    <h3>🔑 API Information</h3>
                                    <button className="close-btn" onClick={() => setShowApiInfo(false)}>×</button>
                                </div>
                                
                                <div className={`api-status ${apiError ? 'error' : 'connected'}`}>
                                    {apiError ? (
                                        <>
                                            <span>❌</span>
                                            <span><strong>API Error Detected</strong> - Key may be invalid or out of credits</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>✅</span>
                                            <span><strong>API Connected</strong> - Ready to generate stories</span>
                                        </>
                                    )}
                                </div>
                                
                                <div style={{fontSize: '0.95rem', lineHeight: '1.6'}}>
                                    <p><strong>Current Key:</strong> ••••••••{apiKey.slice(-4)}</p>
                                    <p><strong>Model:</strong> Qwen-2.5-72B-Instruct</p>
                                    <p><strong>Max Tokens:</strong> 2000</p>
                                    <p><strong>Provider:</strong> OpenRouter.ai</p>
                                    
                                    <h4 style={{marginTop: '1.5rem', marginBottom: '0.5rem'}}>🛠️ Troubleshooting:</h4>
                                    <ul style={{paddingLeft: '1.5rem'}}>
                                        <li>Check your API key is valid at <a href="https://openrouter.ai/keys" target="_blank" style={{color: '#007aff'}}>OpenRouter.ai</a></li>
                                        <li>Ensure you have sufficient credits</li>
                                        <li>Verify your internet connection</li>
                                        <li>Try generating a simpler topic first</li>
                                    </ul>
                                </div>
                                
                                <div className="api-actions">
                                    <button onClick={changeApiKey} className="orange-btn small-btn">
                                        🔄 Change Key
                                    </button>
                                    <button onClick={removeApiKey} className="small-btn" style={{background: '#ff3b30'}}>
                                        🗑️ Remove Key
                                    </button>
                                    <button onClick={() => setShowApiInfo(false)} className="gray-btn small-btn">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AttiTutor));
    </script>
</body>
</html>
